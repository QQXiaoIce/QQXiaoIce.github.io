<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç«¯å¯¹ç«¯åŠ å¯† (èˆ’é€‚äº¤äº’ç‰ˆ)</title>
    <style>
        :root { --primary: #007AFF; --success: #34C759; --error: #FF3B30; --bg: #f2f2f7; --card: #fff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #333; padding: 20px; margin: 0; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 550px; display: grid; gap: 20px; }
        
        /* å¡ç‰‡æ ·å¼ */
        .card { background: var(--card); border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; }
        .card-header { padding: 18px 20px; border-bottom: 1px solid #e5e5ea; font-weight: 600; background: #fff; font-size: 1.1rem;}
        .card-body { padding: 20px; }

        /* é€‰é¡¹å¡ */
        .tabs { display: flex; background: #eef0f2; padding: 4px; border-radius: 10px; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 8px; color: #666; font-size: 0.95rem; transition: all 0.2s; }
        .tab.active { background: #fff; color: var(--primary); font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* è¾“å…¥æ§ä»¶ */
        textarea { width: 100%; padding: 12px; border: 1px solid #e5e5ea; border-radius: 10px; resize: vertical; box-sizing: border-box; font-family: monospace; outline: none; display: block; background: #fafafa; font-size: 15px;}
        textarea:focus { border-color: var(--primary); background: #fff; }
        
        input[type="password"] { width: 100%; padding: 14px; border: 1px solid #e5e5ea; border-radius: 10px; margin-top: 15px; box-sizing: border-box; -webkit-appearance: none; font-size: 16px;}
        input[type="password"]:focus { border-color: var(--primary); }

        /* æŒ‰é’®ç»„ */
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn { flex: 1; border: none; padding: 14px; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; }
        .btn:active { opacity: 0.8; }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-secondary { background: #e5e5ea; color: #333; }

        /* æ–‡ä»¶ä¸Šä¼ åŒº */
        .upload-zone { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; background: #fafafa; transition: all 0.2s; }
        .upload-zone:active { background: #f0f7ff; border-color: var(--primary); }
        
        /* ç»“æœåŒºåŸŸ */
        .result-box { margin-top: 20px; display: none; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Toast æç¤ºæ¡† */
        #toast {
            visibility: hidden; min-width: 250px; background-color: rgba(0,0,0,0.85); color: #fff; text-align: center;
            border-radius: 50px; padding: 12px 20px; position: fixed; z-index: 999; left: 50%; bottom: 30px;
            transform: translateX(-50%); font-size: 0.95rem; backdrop-filter: blur(5px); box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast.error { background-color: rgba(255, 59, 48, 0.9); }
        #toast.success { background-color: rgba(52, 199, 89, 0.9); }
    </style>
</head>
<body>

<div id="toast">æç¤ºä¿¡æ¯</div>

<div class="container">
    <div class="card">
        <div class="card-header">ğŸ”’ åŠ å¯†å‘é€</div>
        <div class="card-body">
            <div class="tabs">
                <div class="tab active" onclick="switchMode('text')">ğŸ“ çº¯æ–‡æœ¬</div>
                <div class="tab" onclick="switchMode('file')">ğŸ“ æ–‡ä»¶ / å›¾ç‰‡</div>
            </div>

            <div id="mode-text">
                <textarea id="plainInput" rows="5" placeholder="åœ¨æ­¤è¾“å…¥è¦åŠ å¯†çš„å†…å®¹..."></textarea>
                
                <div class="result-box" id="cipherResultBox">
                    <div style="font-size:0.9rem; color:#666; margin-bottom:5px; font-weight:bold;">åŠ å¯†ç»“æœ (å¯†æ–‡)ï¼š</div>
                    <textarea id="cipherOutput" rows="4" readonly style="background:#f4f4f5; color:#555; font-size:0.85rem; word-break:break-all;"></textarea>
                    
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="copyToClip()">ğŸ“‹ å¤åˆ¶å¯†æ–‡</button>
                        <button class="btn btn-secondary" onclick="resetTextMode()">ğŸ”„ æ¸…ç©ºé‡ç½®</button>
                    </div>
                </div>
            </div>

            <div id="mode-file" style="display:none;">
                <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size:2rem; margin-bottom:10px;">â˜ï¸</div>
                    <div id="fileNameDisplay">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶<br><span style="font-size:0.8rem; color:#999">æ”¯æŒç²˜è´´æˆªå›¾/æ‹–æ‹½</span></div>
                </div>
                <input type="file" id="fileInput" hidden onchange="updateFileName(this)">
            </div>

            <div id="action-area">
                <input type="password" id="encPassword" placeholder="è®¾ç½®åŠ å¯†å¯†ç  (å¿…å¡«)">
                <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="doEncrypt()">ğŸ”’ å¼€å§‹åŠ å¯†</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">ğŸ”“ è§£å¯†æ¥æ”¶</div>
        <div class="card-body">
            <div style="font-size:0.9rem; color:#666; margin-bottom:10px;">ç²˜è´´å¯†æ–‡ æˆ– é€‰æ‹©æ–‡ä»¶ï¼š</div>
            
            <textarea id="decTextInput" rows="3" placeholder="åœ¨æ­¤ç²˜è´´ Base64 å¯†æ–‡..."></textarea>
            
            <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="document.getElementById('decFileInput').click()">
                ğŸ“‚ æˆ–é€‰æ‹© .enc æ–‡ä»¶
            </button>
            <input type="file" id="decFileInput" hidden onchange="handleDecFileSelect(this)">
            
            <input type="password" id="decPassword" placeholder="è¾“å…¥è§£å¯†å¯†ç ">
            <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="doDecrypt()">ğŸ”“ å¼€å§‹è§£å¯†</button>

            <div class="result-box" id="decResultBox" style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 15px;">
                <div style="color: #15803d; font-weight: bold; margin-bottom: 10px;">âœ… è§£å¯†æˆåŠŸï¼š</div>
                <div id="decContent"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentMode = 'text';
    let fileToEncrypt = null;
    // è¾…åŠ©ï¼šç»™æ–‡ä»¶åæ·»åŠ æ—¶é—´æˆ³ (æ ¼å¼: _YYYYMMDD_HHmmss)
    function addTimestampToName(filename) {
        const now = new Date();
        const timeStr = "_" + 
            now.getFullYear() +
            String(now.getMonth() + 1).padStart(2, '0') +
            String(now.getDate()).padStart(2, '0') + "_" +
            String(now.getHours()).padStart(2, '0') +
            String(now.getMinutes()).padStart(2, '0') +
            String(now.getSeconds()).padStart(2, '0');

        const dotIndex = filename.lastIndexOf('.');
        
        if (dotIndex === -1) {
            // æ²¡æœ‰åç¼€å
            return filename + timeStr;
        } else {
            // æ’å…¥åˆ°åç¼€åå‰
            return filename.substring(0, dotIndex) + timeStr + filename.substring(dotIndex);
        }
    }
    // Toast æç¤ºå·¥å…·
    function showToast(msg, type = 'normal') {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.className = "show"; // é‡ç½®class
        if (type === 'error') toast.classList.add("error");
        if (type === 'success') toast.classList.add("success");
        
        setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
    }

    /* --- ç•Œé¢é€»è¾‘ --- */
    function switchMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        const tabs = document.querySelectorAll('.tab');
        
        if (mode === 'text') {
            tabs[0].classList.add('active');
            document.getElementById('mode-text').style.display = 'block';
            document.getElementById('mode-file').style.display = 'none';
        } else {
            tabs[1].classList.add('active');
            document.getElementById('mode-text').style.display = 'none';
            document.getElementById('mode-file').style.display = 'block';
        }
        document.getElementById('encPassword').value = ''; 
        document.getElementById('cipherResultBox').style.display = 'none';
    }

    function updateFileName(input) {
        if(input.files[0]) {
            fileToEncrypt = input.files[0];
            document.getElementById('fileNameDisplay').innerHTML = `ğŸ“„ <b>${fileToEncrypt.name}</b><br><span style="font-size:0.8rem">(${(fileToEncrypt.size/1024).toFixed(1)} KB)</span>`;
        }
    }

    function handleDecFileSelect(input) {
        if (input.files[0]) {
            document.getElementById('decTextInput').value = `[å·²æŒ‚è½½æ–‡ä»¶: ${input.files[0].name}]`;
            document.getElementById('decTextInput').disabled = true; // é”å®šè¾“å…¥æ¡†ï¼Œé¿å…æ··æ·†
            showToast("å·²é€‰æ‹©æ–‡ä»¶ï¼Œè¯·è¾“å…¥å¯†ç è§£å¯†");
        }
    }

    // å…¨å±€ç²˜è´´æ”¯æŒ
    document.addEventListener('paste', (e) => {
        if(e.target.type === 'password') return;
        const items = e.clipboardData.items;
        for (let item of items) {
            if (item.kind === 'file') {
                fileToEncrypt = item.getAsFile();
                switchMode('file');
                document.getElementById('fileNameDisplay').innerHTML = `ğŸ–¼ï¸ <b>å·²ç²˜è´´å›¾ç‰‡</b><br><span style="font-size:0.8rem">(${(fileToEncrypt.size/1024).toFixed(1)} KB)</span>`;
                e.preventDefault();
                showToast("å·²è¯»å–å‰ªè´´æ¿å›¾ç‰‡");
                return;
            }
        }
    });

    function copyToClip() {
        const copyText = document.getElementById("cipherOutput");
        if(!copyText.value) return;
        copyText.select();
        document.execCommand("copy");
        showToast("å¤åˆ¶æˆåŠŸï¼å¿«å»å‘é€å§", "success");
    }

    function resetTextMode() {
        document.getElementById('plainInput').value = '';
        document.getElementById('cipherOutput').value = '';
        document.getElementById('cipherResultBox').style.display = 'none';
        showToast("å·²æ¸…ç©º");
    }

    /* --- åŠ å¯†æ ¸å¿ƒ --- */
    async function doEncrypt() {
        const pwd = document.getElementById('encPassword').value;
        if (!pwd) return showToast("âš ï¸ è¯·å…ˆè®¾ç½®å¯†ç ", "error");

        try {
            if (currentMode === 'text') {
                // --- æ–‡æœ¬æ¨¡å¼ (é€»è¾‘ä¸å˜) ---
                const text = document.getElementById('plainInput').value;
                if (!text) return showToast("è¯·è¾“å…¥è¦åŠ å¯†çš„æ–‡å­—", "error");

                const data = new TextEncoder().encode(text);
                const { combined } = await encryptData(data, pwd);
                const base64Str = arrayBufferToBase64(combined);
                
                document.getElementById('cipherResultBox').style.display = 'block';
                document.getElementById('cipherOutput').value = base64Str;
                
                document.getElementById('cipherResultBox').scrollIntoView({behavior: "smooth"});
                showToast("åŠ å¯†æˆåŠŸï¼è¯·å¤åˆ¶å¯†æ–‡", "success");

            } else {
                // --- æ–‡ä»¶æ¨¡å¼ (ä¿®æ”¹äº†æ–‡ä»¶åé€»è¾‘) ---
                if (!fileToEncrypt) return showToast("è¯·å…ˆé€‰æ‹©æ–‡ä»¶", "error");
                
                const data = await fileToEncrypt.arrayBuffer();
                const { combined } = await encryptData(data, pwd);
                
                const blob = new Blob([combined]);
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                
                // ã€ä¿®æ”¹æ ¸å¿ƒã€‘ï¼šåŸå§‹æ–‡ä»¶å -> åŠ æ—¶é—´æˆ³ -> åŠ  .enc åç¼€
                // ç»“æœç¤ºä¾‹ï¼šimage_20240321_123055.png.enc
                const nameWithTime = addTimestampToName(fileToEncrypt.name);
                link.download = nameWithTime + ".enc";
                
                document.body.appendChild(link); // å…¼å®¹æ€§æ›´å¥½
                link.click();
                document.body.removeChild(link);
                
                showToast("åŠ å¯†æ–‡ä»¶å·²å¼€å§‹ä¸‹è½½", "success");
            }
        } catch (e) {
            console.error(e);
            showToast("åŠ å¯†è¿‡ç¨‹å‡ºé”™", "error");
        }
    }

    /* --- è§£å¯†æ ¸å¿ƒ --- */
    async function doDecrypt() {
        const pwd = document.getElementById('decPassword').value;
        if (!pwd) return showToast("è¯·è¾“å…¥è§£å¯†å¯†ç ", "error");

        const textInput = document.getElementById('decTextInput');
        const fileInput = document.getElementById('decFileInput');

        try {
            let combinedBuffer;
            let originalName = 'unknown';
            let isFile = false;

            // é€»è¾‘åˆ¤æ–­ï¼šæ˜¯è§£å¯†æ–‡ä»¶ï¼Œè¿˜æ˜¯è§£å¯†æ–‡æœ¬æ¡†ï¼Ÿ
            if (fileInput.files.length > 0 && textInput.disabled) {
                originalName = fileInput.files[0].name.replace(/\.enc$/, '');
                combinedBuffer = await fileInput.files[0].arrayBuffer();
                isFile = true;
            } else {
                const val = textInput.value.trim();
                if (!val) return showToast("è¯·ç²˜è´´å¯†æ–‡æˆ–é€‰æ‹©æ–‡ä»¶", "error");
                if (val.startsWith('[å·²æŒ‚è½½')) return showToast("æ–‡ä»¶çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°é€‰æ‹©", "error");
                combinedBuffer = base64ToArrayBuffer(val);
            }

            const decryptedData = await decryptData(combinedBuffer, pwd);

            // æ˜¾ç¤ºåŒºåŸŸ
            const resultBox = document.getElementById('decResultBox');
            const contentDiv = document.getElementById('decContent');
            resultBox.style.display = 'block';
            contentDiv.innerHTML = ''; 

            if (!isFile) {
                const text = new TextDecoder().decode(decryptedData);
                // ä½¿ç”¨ Textarea é˜²æ­¢æ³¨å…¥ + æ–¹ä¾¿é˜…è¯»
                const out = document.createElement('textarea');
                out.value = text;
                out.rows = 6;
                out.style.width = '100%';
                out.style.border = '1px solid #ddd';
                out.style.borderRadius = '8px';
                out.style.padding = '10px';
                out.style.background = '#fff';
                out.readOnly = true;
                contentDiv.appendChild(out);
                
                // æ·»åŠ â€œå¤åˆ¶æ˜æ–‡â€æŒ‰é’®
                const copyBtn = document.createElement('button');
                copyBtn.className = 'btn btn-success';
                copyBtn.style.marginTop = '10px';
                copyBtn.innerText = 'ğŸ“‹ å¤åˆ¶æ˜æ–‡';
                copyBtn.onclick = function() {
                    out.select();
                    document.execCommand('copy');
                    showToast("æ˜æ–‡å·²å¤åˆ¶", "success");
                };
                contentDiv.appendChild(copyBtn);

            } else {
                let type = 'application/octet-stream';
                if (/\.(png|jpg|jpeg|gif)$/i.test(originalName)) type = 'image/png';
                
                const blob = new Blob([decryptedData], {type: type});
                const url = URL.createObjectURL(blob);

                if (type.startsWith('image')) {
                    const img = document.createElement('img');
                    img.src = url;
                    img.style.maxWidth = '100%';
                    img.style.borderRadius = '8px';
                    contentDiv.appendChild(img);
                }
                
                const link = document.createElement('a');
                link.href = url;
                link.download = originalName;
                link.innerHTML = `<div style="background:#fff; padding:15px; border-radius:10px; border:1px solid #ddd; margin-top:10px; text-align:center; font-weight:bold; color:var(--primary)">â¬‡ï¸ ç‚¹å‡»ä¸‹è½½è¿˜åŸæ–‡ä»¶<br><span style="font-size:0.8rem; font-weight:normal; color:#666">${originalName}</span></div>`;
                link.style.textDecoration = 'none';
                contentDiv.appendChild(link);
            }
            
            showToast("è§£å¯†æˆåŠŸï¼", "success");
            resultBox.scrollIntoView({behavior: "smooth"});

        } catch (e) {
            console.error(e);
            showToast("è§£å¯†å¤±è´¥ï¼šå¯†ç é”™è¯¯æˆ–æ•°æ®æŸå", "error");
        }
    }

    /* --- åŠ å¯†ç®—æ³• (AES-GCM + Salt) --- */
    async function encryptData(dataBuffer, password) {
        const iv = window.crypto.getRandomValues(new Uint8Array(12));
        const salt = window.crypto.getRandomValues(new Uint8Array(16));
        const key = await generateKey(password, salt);
        const encrypted = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, dataBuffer);
        const combined = new Uint8Array(16 + 12 + encrypted.byteLength);
        combined.set(salt, 0);
        combined.set(iv, 16);
        combined.set(new Uint8Array(encrypted), 28);
        return { combined };
    }

    async function decryptData(combinedBuffer, password) {
        const salt = combinedBuffer.slice(0, 16);
        const iv = combinedBuffer.slice(16, 28);
        const data = combinedBuffer.slice(28);
        const key = await generateKey(password, salt);
        return await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, data);
    }

    async function generateKey(password, salt) {
        const enc = new TextEncoder();
        const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
        return window.crypto.subtle.deriveKey({ name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" }, keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]);
    }

    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
        return window.btoa(binary);
    }

    function base64ToArrayBuffer(base64) {
        const binary_string = window.atob(base64.replace(/\s/g, ''));
        const len = binary_string.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = binary_string.charCodeAt(i);
        return bytes.buffer;
    }


</script>
</body>
</html>